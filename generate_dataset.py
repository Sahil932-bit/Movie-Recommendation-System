"""
Generate sample MovieLens-format dataset (movies.csv and ratings.csv).
Reads movie catalog from dataset/movie_catalog.csv; ratings are generated by this script.
"""

import csv
import os
import random
from datetime import datetime, timedelta

# Paths
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
CATALOG_PATH = os.path.join(SCRIPT_DIR, "dataset", "movie_catalog.csv")
MOVIES_OUTPUT = os.path.join(SCRIPT_DIR, "data", "movies.csv")
RATINGS_OUTPUT = os.path.join(SCRIPT_DIR, "data", "ratings.csv")

# Rating generation settings (change these if needed)
NUM_USERS = 80
MIN_RATINGS_PER_USER = 10
MAX_RATINGS_PER_USER = 150
RATING_STEPS = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0]


def load_movie_catalog(path=None):
    """Load movie catalog from CSV. Returns list of (movieId, title, genres)."""
    path = path or CATALOG_PATH
    if not os.path.exists(path):
        raise FileNotFoundError(f"Movie catalog not found: {path}")
    movies = []
    with open(path, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            movies.append((
                int(row["movieId"]),
                row["title"],
                row["genres"],
            ))
    return movies


def random_timestamp(start_year=2015, end_year=2024):
    """Generate random Unix timestamp between start and end year."""
    start = datetime(start_year, 1, 1)
    end = datetime(end_year, 12, 31)
    delta = (end - start).total_seconds()
    ts = start + timedelta(seconds=random.randint(0, int(delta)))
    return int(ts.timestamp())


def write_movies_csv(movies, path=None):
    """Write movies to data/movies.csv (from catalog)."""
    path = path or MOVIES_OUTPUT
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w", newline="", encoding="utf-8") as f:
        w = csv.writer(f)
        w.writerow(["movieId", "title", "genres"])
        w.writerows(movies)
    print(f"Written {len(movies)} movies to {path}")


def write_ratings_csv(movie_ids, path=None):
    """Generate and write ratings.csv from movie IDs."""
    path = path or RATINGS_OUTPUT
    os.makedirs(os.path.dirname(path), exist_ok=True)
    rows = []
    for user_id in range(1, NUM_USERS + 1):
        n_ratings = random.randint(
            MIN_RATINGS_PER_USER,
            min(MAX_RATINGS_PER_USER, len(movie_ids)),
        )
        rated = random.sample(movie_ids, n_ratings)
        for movie_id in rated:
            rating = random.choice(RATING_STEPS)
            ts = random_timestamp()
            rows.append((user_id, movie_id, rating, ts))
    rows.sort(key=lambda x: x[3])
    with open(path, "w", newline="", encoding="utf-8") as f:
        w = csv.writer(f)
        w.writerow(["userId", "movieId", "rating", "timestamp"])
        w.writerows(rows)
    print(f"Written {len(rows)} ratings for {NUM_USERS} users to {path}")


def main():
    """Load catalog, write data/movies.csv and data/ratings.csv."""
    movies = load_movie_catalog()
    movie_ids = [m[0] for m in movies]
    write_movies_csv(movies)
    write_ratings_csv(movie_ids)
    print("\nDataset generation complete. You can now run: python main.py")


if __name__ == "__main__":
    main()
